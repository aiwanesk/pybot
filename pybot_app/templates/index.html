{% extends "layout.html" %}  

{% block content %}

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div style="background-color: white">
        {% for message in messages %}
        <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <section>
        <div id="mapid"></div>
        <div id="bot-answer"></div>
    </section>
    
    <div id="request"></div>

    <p>Quelle adresse cherches-tu ?</p>
    <form method="POST" novalidate>
        {# Add SECRET_KEY to protect the form with hidden tag #}
        {# form.hidden_tag() #}
        <p>
            {{ form.address.label }}
            {{ form.address }}
            {% for error in form.address.errors %}
            <span style="color: red; font-weight: bold;">{{ error }}</span>
            {% endfor %}
        </p>
        <p>
            {{ form.submit() }}
        </p>

    </form>
    
    <!-- Ajax call to display a map -->
    <script type="text/javascript">
        $(document).ready(function(){
    
            var mymap;
    
            $("form").submit(function(e){
                $("#mapid").html('<i class="fas fa-circle-notch fa-spin"></i>');

                e.preventDefault();
    
                var address_request = $("input").val();

                // Display the request as a chat message
                $("#request").append('<p>' + address_request + '</p>');
    
                $.post('/ajax-osm', {
                    address_request : address_request
                }).done(function(response){
                    
                    if (response['address']){
                        var latitude = response['address']['latitude'];
                        var longitude = response['address']['longitude'];
    
                        if (typeof mymap !== 'undefined'){
                            mymap.remove();  
                        }
    
                        mymap = L.map('mapid').setView([latitude, longitude], 15);
                        var marker = L.marker([latitude, longitude]).addTo(mymap);                        
    
                        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibXZiLWhkZiIsImEiOiJjams1ZTdlNXQxN3lpM2txcXBlMHM1a3I0In0.T77BUlkk9mb8FDqlKRS3ZA', {
                            maxZoom: 18,
                            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                            id: 'mapbox.streets',
                        }).addTo(mymap);
                    }
                    else{
                        $('#bot-answer').append('<p>Malheureusement, il semble que cet endroit ne soit pas encore repertorié sur OpenStreetMap. Nhésite pas à contribuer en le rajoutant toi-même : </p>');
                        $('#bot-answer').append('<a href="https://www.openstreetmap.org/" target="_blank">https://www.openstreetmap.org/</a>');
                    }
                }).fail(function(response){
                    console.log(response)
                });
            });
        });
    </script>

{% endblock %}